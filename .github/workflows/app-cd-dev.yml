name: App CD - Dev - Deploy to GKE via Helm

on:
  workflow_run:
    workflows:
      - App CI - Dev - Build & Push Images
    types: [completed]

concurrency:
  group: app-cd-dev
  cancel-in-progress: true

permissions:
  contents: read
  id-token: write

env:
  PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  ENVIRONMENT: dev

jobs:
  deploy-dev:
    name: Deploy to GKE (dev)
    runs-on: ubuntu-latest
    environment: dev

    # ✅ HARD gate – only successful CI on dev branch
    if: |
      github.event.workflow_run.conclusion == 'success' 

    env:
      WIF_PROVIDER_DEV: ${{ secrets.WIF_PROVIDER_DEV }}
      DEV_GKE_CLUSTER: ${{ secrets.DEV_GKE_CLUSTER }}
      DEV_GKE_ZONE: ${{ secrets.DEV_GKE_REGION }}
      DEV_SA: ${{ secrets.DEV_SA }}

    steps:
      # --------------------------------------------------
      # Debug workflow_run context (CRITICAL)
      # --------------------------------------------------
      - name: Debug workflow_run context
        run: |
          echo "workflow=${{ github.event.workflow_run.name }}"
          echo "conclusion=${{ github.event.workflow_run.conclusion }}"
          echo "head_branch=${{ github.event.workflow_run.head_branch }}"
          echo "head_sha=${{ github.event.workflow_run.head_sha }}"
          echo "run_id=${{ github.event.workflow_run.id }}"

      # --------------------------------------------------
      # Checkout exact same commit CI used
      # --------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}

      # --------------------------------------------------
      # Download image metadata from CI
      # --------------------------------------------------
      - name: Download images-dev artifact
        uses: actions/download-artifact@v4
        with:
          name: images-dev
          run-id: ${{ github.event.workflow_run.id }}
          path: images

      # --------------------------------------------------
      # Authenticate to GCP (WIF)
      # --------------------------------------------------
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER_DEV }}
          service_account: ${{ env.DEV_SA }}
          project_id: ${{ env.PROJECT_ID }}

      # --------------------------------------------------
      # Get GKE credentials
      # --------------------------------------------------
      - name: Get GKE credentials (dev)
        run: |
          gcloud container clusters get-credentials "$DEV_GKE_CLUSTER" \
            --zone "$DEV_GKE_ZONE" \
            --project "$PROJECT_ID"

      # --------------------------------------------------
      # Setup Helm
      # --------------------------------------------------
      - name: Setup Helm
        uses: azure/setup-helm@v3

      # --------------------------------------------------
      # Parse image tags
      # --------------------------------------------------
      - name: Prepare image tags
        id: imgs
        run: |
         IMAGES_JSON=images/images.json

         jq . "$IMAGES_JSON"

         echo "app_repo=$(jq -r '."application-service" | split(":")[0]' $IMAGES_JSON)" >> $GITHUB_OUTPUT
         echo "app_tag=$(jq -r '."application-service" | split(":")[1]' $IMAGES_JSON)" >> $GITHUB_OUTPUT

         echo "patient_repo=$(jq -r '."patient-service" | split(":")[0]' $IMAGES_JSON)" >> $GITHUB_OUTPUT
         echo "patient_tag=$(jq -r '."patient-service" | split(":")[1]' $IMAGES_JSON)" >> $GITHUB_OUTPUT

         echo "order_repo=$(jq -r '."order-service" | split(":")[0]' $IMAGES_JSON)" >> $GITHUB_OUTPUT
         echo "order_tag=$(jq -r '."order-service" | split(":")[1]' $IMAGES_JSON)" >> $GITHUB_OUTPUT

