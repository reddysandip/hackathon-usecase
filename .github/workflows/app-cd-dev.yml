name: App CD - Dev - Deploy to GKE

on:
  workflow_call:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      WIF_PROVIDER_DEV: ${{ secrets.WIF_PROVIDER_DEV }}
      DEV_SA: ${{ secrets.DEV_SA }}
      DEV_GKE_CLUSTER: ${{ secrets.DEV_GKE_CLUSTER }}
      DEV_GKE_ZONE: ${{ secrets.DEV_GKE_ZONE }}

    steps:
      - uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          name: images-dev
          path: images

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.WIF_PROVIDER_DEV }}
          service_account: ${{ env.DEV_SA }}
          project_id: ${{ env.PROJECT_ID }}

      - name: Get GKE credentials
        run: |
          gcloud container clusters get-credentials "$DEV_GKE_CLUSTER" \
            --zone "$DEV_GKE_ZONE" \
            --project "$PROJECT_ID"

      - name: Setup Helm
        uses: azure/setup-helm@v3

      - name: Ensure namespace exists
        run: |
          kubectl get ns dev || kubectl create ns dev

      - name: Deploy with Helm
        run: |
          helm upgrade --install hackathon helm/umbrella \
            --namespace dev \
            --set application.image=$(jq -r '."application-service"' images/images.json) \
            --set patient.image=$(jq -r '."patient-service"' images/images.json) \
            --set order.image=$(jq -r '."order-service"' images/images.json)
